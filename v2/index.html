<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iOS 스타일 위로 넘기는 카드덱 - 스테이블1</title>
<style>
body {
  background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
  display: flex;
  justify-content: center;
  align-items: flex-start;
  height: 100vh;
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  overflow: hidden;
  padding-top: 90px;
  box-sizing: border-box;
}

.deck {
  position: relative;
  width: 700px;
  height: 1000px;
  perspective: 1200px;
}

.card {
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 20px;
  background: #f8f9fa;
  box-shadow: 
    0 15px 30px rgba(0,0,0,0.06),
    0 10px 20px rgba(0,0,0,0.04),
    0 3px 8px rgba(0,0,0,0.03);
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 2em;
  font-weight: 600;
  color: #333;
  cursor: grab;
  user-select: none;
  transform-origin: center center;
  transition: box-shadow 0.3s ease;
}

.card:hover {
  box-shadow: 
    0 20px 40px rgba(0,0,0,0.08),
    0 15px 25px rgba(0,0,0,0.06),
    0 5px 12px rgba(0,0,0,0.04);
}

.card:active {
  cursor: grabbing;
}

@media (max-width: 768px) {
  body {
    padding-top: 70px;
  }
  
  .deck {
    width: min(90vw, 400px);
    height: calc(min(90vw, 400px) * 1.4);
  }
  .card {
    font-size: 1.5em;
  }
}
</style>
</head>
<body>
<div class="deck">
  <div class="card">1</div>
  <div class="card">2</div>
  <div class="card">3</div>
  <div class="card">4</div>
  <div class="card">5</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/Draggable.min.js"></script>
<script>
const deck = document.querySelector(".deck");
let cards = Array.from(deck.querySelectorAll(".card"));
let currentDraggable = null;
let animationId = null;

function layoutCards() {
  cards.forEach((card, i) => {
    gsap.set(card, {
      zIndex: cards.length - i,
      scale: 1 - i * 0.05,
      y: i * 80,
      opacity: i < 4 ? 1 : 0,
      x: 0
    });
  });
}

layoutCards();

function optimizedOnDrag(draggableInstance) {
  if (animationId) return;
  
  animationId = requestAnimationFrame(() => {
    if (cards[1] && draggableInstance.y !== undefined) {
      const progress = Math.min(Math.abs(draggableInstance.y) / 150, 1);
      const easeProgress = easeOutCubic(progress);
      
      gsap.set(cards[1], {
        y: 80 - (easeProgress * 40),
        scale: (1 - 0.05) + (easeProgress * 0.05)
      });
      
      if (cards[2]) {
        gsap.set(cards[2], {
          y: 160 - (easeProgress * 15),
          scale: (1 - 0.1) + (easeProgress * 0.025)
        });
      }
    }
    animationId = null;
  });
}

function easeOutCubic(t) {
  return 1 - Math.pow(1 - t, 3);
}

function initTopCard() {
  let topCard = cards[0];
  if (!topCard) {
    console.log('topCard가 없음');
    return;
  }
  
  console.log('initTopCard 호출됨, topCard:', topCard.textContent);
  
  if (currentDraggable) {
    console.log('이전 Draggable 정리 중...');
    currentDraggable.kill();
    currentDraggable = null;
  }
  
  if (animationId) {
    cancelAnimationFrame(animationId);
    animationId = null;
  }
  
  try {
    currentDraggable = Draggable.create(topCard, {
      type: "y",
      inertia: true,
      onDrag() {
        optimizedOnDrag(this);
      },
      onRelease() {
        if (animationId) {
          cancelAnimationFrame(animationId);
          animationId = null;
        }
        
        if (this.y < -100) {
          if (navigator.vibrate) {
            navigator.vibrate(50);
          }
          
          gsap.to(topCard, {
            y: -window.innerHeight - 50,
            opacity: 0,
            scale: 0.9,
            duration: 0.5,
            ease: "power2.in",
            onComplete: () => {
              deck.appendChild(topCard);
              cards = Array.from(deck.querySelectorAll(".card"));
              
              const newCard = cards[cards.length - 1];
              const newCardIndex = cards.length - 1;
              
              console.log('새 카드 인덱스:', newCardIndex);
              
              cards.forEach((card, i) => {
                if (card !== newCard) {
                  gsap.set(card, {
                    zIndex: cards.length - i,
                    scale: 1 - i * 0.05,
                    y: i * 80,
                    opacity: i < 4 ? 1 : 0,
                    x: 0
                  });
                }
              });
              
              const lastVisibleIndex = 3;
              
              if (cards.length > lastVisibleIndex) {
                const visibleNewCard = cards[lastVisibleIndex];
                
                gsap.set(visibleNewCard, {
                  zIndex: cards.length - lastVisibleIndex,
                  scale: 1 - lastVisibleIndex * 0.05,
                  y: lastVisibleIndex * 80 - 100,
                  opacity: 1,
                  x: 0
                });
                
                console.log('새 카드 애니메이션 시작 (3번 자리)');
                
                // setTimeout으로 즉시 다음 드래그 준비
                setTimeout(() => {
                  console.log('다음 드래그 준비됨');
                  initTopCard();
                }, 0);
                
                gsap.to(visibleNewCard, {
                  y: lastVisibleIndex * 80,
                  duration: 0.8,
                  ease: "power2.out",
                  onComplete: () => {
                    console.log('새 카드 애니메이션 완료');
                  }
                });
              } else {
                setTimeout(() => {
                  console.log('다음 드래그 준비됨 (4장 미만)');
                  initTopCard();
                }, 0);
              }
            }
          });
          
          cards.slice(1).forEach((card, i) => {
            if (i < 3) {
              gsap.to(card, {
                y: i * 80,
                scale: 1 - i * 0.05,
                duration: 0.6,
                ease: "back.out(1.7)",
                delay: i * 0.05
              });
            }
          });
        } else {
          gsap.to(topCard, { 
            y: 0, 
            duration: 0.6,
            ease: "back.out(1.7)"
          });
          
          if (cards[1]) {
            gsap.to(cards[1], {
              y: 80,
              scale: 1 - 0.05,
              duration: 0.6,
              ease: "back.out(1.7)"
            });
          }
          
          if (cards[2]) {
            gsap.to(cards[2], {
              y: 160,
              scale: 1 - 0.1,
              duration: 0.6,
              ease: "back.out(1.7)"
            });
          }
        }
      }
    })[0];
    
    console.log('Draggable 생성 완료');
  } catch (error) {
    console.error('Draggable 생성 실패:', error);
  }
}

initTopCard();

window.addEventListener('beforeunload', () => {
  if (currentDraggable) {
    currentDraggable.kill();
  }
  if (animationId) {
    cancelAnimationFrame(animationId);
  }
});
</script>
</body>
</html>
